<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compare LX</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        canvas {
            max-width: 100%;
            height: auto;
        }
        #loading {
            display: none;
        }
    </style>
</head>
<body>
    <h1>Welcome to Compare LX</h1>
    <p>This is the homepage for the Compare LX project.</p>
    <div id="loading">Loading data...</div>
    <canvas id="myChart" width="600" height="400"></canvas>
    
    <script>
        var degreesData = [];
        var facultyData = [];

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function fetchData() {
            showLoading(true);
            Papa.parse('./BA-LX-degrees-conferred.csv', {
                download: true,
                header: true,
                complete: function(results) {
                    degreesData = results.data.map(row => {
                        let institution = row.InstitutionName;
                        let yearsData = [];
                        Object.keys(row).forEach(year => {
                            if (year !== 'InstitutionName') {
                                yearsData.push({
                                    year: year,
                                    degrees: row[year],
                                    institution: institution
                                });
                            }
                        });
                        return yearsData;
                    }).flat();
                    if (facultyData.length > 0) {
                        mergeData();
                    }
                }
            });

            Papa.parse('./num-core-faculty.csv', {
                download: true,
                header: true,
                complete: function(results) {
                    facultyData = results.data;
                    if (degreesData.length > 0) {
                        mergeData();
                    }
                }
            });
        }

        function mergeData() {
            const mergedData = degreesData.map(degree => {
                const faculty = facultyData.find(fac => fac.InstitutionName === degree.institution);
                return {
                    ...degree,
                    Faculty_Count: faculty ? faculty.Faculty_Count : null
                };
            });
            processMergedData(mergedData);
        }

        function processMergedData(data) {
            console.log(data);
            createChart();
            showLoading(false);
        }

        function createChart() {
            window.myChart = new Chart(document.getElementById('myChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateChart() {
            const selectedUniversities = Array.from(document.getElementById('universitySelect').selectedOptions).map(option => option.value);
            const startYear = document.getElementById('startYear').value;
            const endYear = document.getElementById('endYear').value;

            const filteredData = degreesData.filter(item => 
                selectedUniversities.includes(item.institution) &&
                item.year >= startYear && item.year <= endYear
            );

            const labels = Array.from(new Set(filteredData.map(item => item.year))).sort();
            const datasets = selectedUniversities.map(university => {
                const universityData = filteredData.filter(item => item.institution === university);
                return {
                    label: university,
                    data: labels.map(year => {
                        const dataPoint = universityData.find(item => item.year === year);
                        return dataPoint ? dataPoint.degrees : null;
                    }),
                    borderColor: getRandomColor(),
                    backgroundColor: 'rgba(0,0,0,0)',
                    fill: false
                };
            });

            window.myChart.data.labels = labels;
            window.myChart.data.datasets = datasets;
            window.myChart.update();
        }

        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        window.onload = fetchData;
    </script>
    
    <label for="universitySelect">Select Universities:</label>
    <select id="universitySelect" multiple onchange="updateChart()">
        <!-- Dynamically populated options will be added here -->
    </select>

    <label for="startYear">Start Year:</label>
    <select id="startYear" onchange="updateChart()">
        <option value="1999">1999</option>
        <option value="2000">2000</option>
        <!-- Add all the years up to 2023 here -->
    </select>

    <label for="endYear">End Year:</label>
    <select id="endYear" onchange="updateChart()">
        <option value="2023">2023</option>
        <option value="2022">2022</option>
        <!-- Add all the years here -->
    </select>
    
</body>
</html>
