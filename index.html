<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>University Data Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.3.0/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        select, canvas {
            margin: 10px;
        }
    </style>
</head>
<body>
    <h1>University Data Visualization</h1>

    <label for="universitySelect">Select University:</label>
    <select id="universitySelect"></select>

    <label for="plotTypeSelect">Select Plot Type:</label>
    <select id="plotTypeSelect">
        <option value="line">Degrees by Year</option>
        <option value="scatter">Degrees vs Faculty</option>
    </select>

    <label for="startYear">Start Year:</label>
    <select id="startYear"></select>

    <label for="endYear">End Year:</label>
    <select id="endYear"></select>

    <canvas id="myChart"></canvas>

    <script>
        // Global variables
        let degreesData = {};
        let facultyData = {};
        let universityNames = [];
        let yearsAvailable = [];

        // Populate dropdowns
        function populateDropdowns() {
            const universitySelect = document.getElementById('universitySelect');
            universityNames.sort((a, b) => a.localeCompare(b));

            universityNames.forEach(name => {
                let option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                universitySelect.appendChild(option);
            });

            const startYearSelect = document.getElementById('startYear');
            const endYearSelect = document.getElementById('endYear');
            yearsAvailable = [...new Set(yearsAvailable)].sort();

            yearsAvailable.forEach(year => {
                let optionStart = document.createElement('option');
                optionStart.value = year;
                optionStart.textContent = year;
                startYearSelect.appendChild(optionStart);

                let optionEnd = document.createElement('option');
                optionEnd.value = year;
                optionEnd.textContent = year;
                endYearSelect.appendChild(optionEnd);
            });

            console.log('Dropdowns Populated'); // Debugging
        }

        // Fetch data
        function fetchData() {
            Papa.parse('./BA-LX-degrees-conferred.csv', {
                download: true,
                header: true,
                complete: function(results) {
                    degreesData = parseCSV(results.data);
                    fetchCSV('./num-core-faculty.csv', function(facultyResults) {
                        facultyData = parseCSV(facultyResults.data);
                        populateDropdowns();
                    });
                }
            });
        }

        // Fetch CSV data
        function fetchCSV(url, callback) {
            Papa.parse(url, {
                download: true,
                header: true,
                complete: callback
            });
        }

        // Parse CSV into JSON
        function parseCSV(data) {
            const result = {};
            data.forEach(row => {
                const key = row.InstitutionName;
                result[key] = Object.values(row).slice(1).map(Number);
                if (!universityNames.includes(key)) {
                    universityNames.push(key);
                }
            });
            yearsAvailable = Object.keys(result[universityNames[0]]).map(Number); // Assuming all universities have the same years
            return result;
        }

        // Update plot
        function updatePlot() {
            const plotType = document.getElementById('plotTypeSelect').value;
            const university = document.getElementById('universitySelect').value;
            const startYear = parseInt(document.getElementById('startYear').value);
            const endYear = parseInt(document.getElementById('endYear').value);

            const ctx = document.getElementById('myChart').getContext('2d');
            let chart = Chart.getChart('myChart');

            if (chart) {
                chart.destroy(); // Clear the old chart
            }

            if (plotType === 'line') {
                const labels = [];
                const data = [];
                for (let year = startYear; year <= endYear; year++) {
                    if (degreesData[university] && degreesData[university][year - yearsAvailable[0]] !== undefined) {
                        labels.push(year);
                        data.push(degreesData[university][year - yearsAvailable[0]]);
                    }
                }

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Degrees Conferred',
                            data: data,
                            borderColor: 'blue',
                            fill: false
                        }]
                    }
                });

            } else if (plotType === 'scatter') {
                const avgDegrees = [];
                const facultyNumbers = [];

                for (const year in degreesData[university]) {
                    if (year >= startYear && year <= endYear) {
                        avgDegrees.push(degreesData[university][year - yearsAvailable[0]]);
                    }
                }

                const avgDegree = avgDegrees.reduce((a, b) => a + b, 0) / avgDegrees.length;
                const facultyNumber = facultyData[university] ? facultyData[university][yearsAvailable.indexOf(2019)] : 0;

                new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'Degrees vs Faculty',
                            data: [{ x: facultyNumber, y: avgDegree }],
                            backgroundColor: 'red'
                        }]
                    }
                });
            }
        }

        // Event listeners
        document.getElementById('plotTypeSelect').addEventListener('change', updatePlot);
        document.getElementById('universitySelect').addEventListener('change', updatePlot);
        document.getElementById('startYear').addEventListener('change', updatePlot);
        document.getElementById('endYear').addEventListener('change', updatePlot);

        // Initial setup
        fetchData();
    </script>
</body>
</html>
