<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Compare LX</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
      /* Basic styling for tabs */
      .tab-container {
        display: flex;
        cursor: pointer;
        margin-bottom: 20px;
      }
      .tab {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px 5px 0 0;
        margin-right: 5px;
        background-color: #f1f1f1;
      }
      .tab-active {
        background-color: white;
        border-bottom: 1px solid white;
        font-weight: bold;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
    </style>
  </head>
  <body>
    <h1>Welcome to Compare LX</h1>
    <p>This is the homepage for the Compare LX project.</p>

    <!-- Tabs for the charts -->
    <div class="tab-container">
      <div class="tab tab-active" onclick="openTab('degreesByYear')">
        LX Degrees Conferred by Year
      </div>
      <div class="tab" onclick="openTab('degreesVsFaculty')">
        Average LX Degrees Conferred by Number of LX Faculty
      </div>
    </div>

    <!-- Tab content for charts -->
    <div id="degreesByYear" class="tab-content active">
      <canvas id="degreesByYearChart" width="600" height="400"></canvas>
    </div>
    <div id="degreesVsFaculty" class="tab-content">
      <canvas id="degreesVsFacultyChart" width="600" height="400"></canvas>
    </div>

    <fieldset id="universityFieldset">
      <legend>Select Universities:</legend>
      <!-- Dynamically populated checkboxes will be added here -->
    </fieldset>

    <label for="startYear">Start Year:</label>
    <select id="startYear" onchange="updateCharts()">
      <!-- Options will be added here dynamically -->
    </select>

    <label for="endYear">End Year:</label>
    <select id="endYear" onchange="updateCharts()">
      <!-- Options will be added here dynamically -->
    </select>

    <script>
      var degreesData = [];
      var facultyData = [];
      var universityNames = [];
      var yearsAvailable = [];
      var degreesByYearChart = null;
      var degreesVsFacultyChart = null;

      // Load the degrees CSV
      Papa.parse("./BA-LX-degrees-conferred.csv", {
        download: true,
        header: true,
        complete: function (results) {
          console.log("Degrees CSV Loaded:", results.data); // Debugging

          degreesData = results.data.map((row) => {
            let institution = row.InstitutionName;
            if (!universityNames.includes(institution)) {
              universityNames.push(institution);
            }

            // Capture years from the data for dropdowns
            for (let year in row) {
              if (year.match(/^\d{4}$/)) {
                // Match years in format YYYY
                if (!yearsAvailable.includes(year)) {
                  yearsAvailable.push(year);
                }
              }
            }

            return row; // Return the whole row for further processing
          });

          console.log("Degrees Data:", degreesData); // Debugging
          console.log("University Names:", universityNames); // Debugging

          populateDropdowns();
          if (facultyData.length > 0) {
            updateCharts(); // Update charts after both CSVs are loaded
          }
        },
      });

      // Load the faculty CSV
      Papa.parse("./num-core-faculty.csv", {
        download: true,
        header: true,
        complete: function (results) {
          console.log("Faculty CSV Loaded:", results.data); // Debugging
          facultyData = results.data;
          if (degreesData.length > 0) {
            updateCharts(); // Update charts after both CSVs are loaded
          }
        },
      });

      // Populate the dropdowns with options
      function populateDropdowns() {
        const universityFieldset =
          document.getElementById("universityFieldset");
        universityNames.sort((a, b) => a.localeCompare(b));

        universityNames.forEach((name) => {
          let checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.id = name;
          checkbox.value = name;
          checkbox.name = "university";

          let label = document.createElement("label");
          label.htmlFor = name;
          label.textContent = name;

          universityFieldset.appendChild(checkbox);
          universityFieldset.appendChild(label);
          universityFieldset.appendChild(document.createElement("br"));

          // Add event listener to each checkbox
          checkbox.addEventListener("change", updateCharts);
        });

        const startYearSelect = document.getElementById("startYear");
        const endYearSelect = document.getElementById("endYear");
        yearsAvailable = [...new Set(yearsAvailable)].sort(); // Remove duplicates and sort

        yearsAvailable.forEach((year) => {
          let optionStart = document.createElement("option");
          optionStart.value = year;
          optionStart.textContent = year;
          startYearSelect.appendChild(optionStart);

          let optionEnd = document.createElement("option");
          optionEnd.value = year;
          optionEnd.textContent = year;
          endYearSelect.appendChild(optionEnd);
        });

        // Set default values for start and end year
        if (yearsAvailable.length > 0) {
          startYearSelect.value = yearsAvailable[0]; // Set default start year
          endYearSelect.value = yearsAvailable.includes("2023")
            ? "2023"
            : yearsAvailable[yearsAvailable.length - 1]; // Set default end year to 2023 if available, otherwise the latest year
        }

        console.log("Dropdowns Populated"); // Debugging
      }

      function updateCharts() {
        const selectedUniversities = Array.from(
          document.querySelectorAll("#universityFieldset input:checked")
        ).map((checkbox) => checkbox.value);
        const startYear = document.getElementById("startYear").value;
        const endYear = document.getElementById("endYear").value;

        // Degrees by Year Chart
        let degreesByYearDatasets = [];
        selectedUniversities.forEach((university) => {
          const universityData = degreesData.filter(
            (item) => item.InstitutionName === university
          );

          let dataset = {
            label: university,
            data: [],
            borderColor: getRandomColor(),
            backgroundColor: "rgba(75, 192, 192, 0.2)",
            fill: false,
          };

          yearsAvailable.forEach((year) => {
            if (
              parseInt(year) >= parseInt(startYear) &&
              parseInt(year) <= parseInt(endYear)
            ) {
              let degrees = 0;

              universityData.forEach((row) => {
                if (row[year]) {
                  degrees += parseFloat(row[year]);
                }
              });

              dataset.data.push({ x: parseInt(year), y: degrees });
            }
          });

          if (dataset.data.length > 0) {
            degreesByYearDatasets.push(dataset);
          }
        });

        // Create or update Degrees by Year Chart
        if (degreesByYearChart) {
          degreesByYearChart.destroy(); // Destroy existing chart instance
        }
        var ctx1 = document
          .getElementById("degreesByYearChart")
          .getContext("2d");
        degreesByYearChart = new Chart(ctx1, {
          type: "line",
          data: {
            datasets: degreesByYearDatasets,
          },
          options: {
            responsive: true,
            scales: {
              x: {
                type: "linear",
                position: "bottom",
                title: {
                  display: true,
                  text: "Year",
                },
                ticks: {
                  callback: function (value, index, values) {
                    return value; // Display year as-is
                  },
                },
              },
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "Number of Degrees Conferred",
                },
              },
            },
            plugins: {
              legend: {
                display: true,
              },
            },
          },
        });

        // Degrees vs Faculty Chart
        let degreesVsFacultyDatasets = [];
        selectedUniversities.forEach((university) => {
          const universityAverage = degreesData.find(
            (item) => item.InstitutionName === university
          )?.["Average"];
          const facultyCount = facultyData.find(
            (item) => item.InstitutionName === university
          )?.["2019"];

          // Ensure valid numbers
          if (!isNaN(universityAverage) && facultyCount) {
            let data = {
              label: university,
              data: [
                {
                  x: parseFloat(facultyCount),
                  y: parseFloat(universityAverage),
                },
              ],
              borderColor: getRandomColor(),
              backgroundColor: "rgba(75, 192, 192, 0.2)",
              fill: false,
            };

            degreesVsFacultyDatasets.push(data);
          }
        });

        // Create or update Degrees vs Faculty Chart
        if (degreesVsFacultyChart) {
          degreesVsFacultyChart.destroy(); // Destroy existing chart instance
        }
        var ctx2 = document
          .getElementById("degreesVsFacultyChart")
          .getContext("2d");
        degreesVsFacultyChart = new Chart(ctx2, {
          type: "scatter",
          data: {
            datasets: degreesVsFacultyDatasets,
          },
          options: {
            responsive: true,
            scales: {
              x: {
                title: {
                  display: true,
                  text: "Faculty Count",
                },
              },
              y: {
                title: {
                  display: true,
                  text: "Degrees Conferred",
                },
              },
            },
            plugins: {
              legend: {
                display: true,
              },
            },
          },
        });
      }

      function openTab(tabId) {
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.classList.remove("tab-active");
        });
        document.querySelectorAll(".tab-content").forEach((content) => {
          content.classList.remove("active");
        });

        document
          .querySelector(`.tab[onclick="openTab('${tabId}')"]`)
          .classList.add("tab-active");
        document.getElementById(tabId).classList.add("active");
      }

      function getRandomColor() {
        const letters = "0123456789ABCDEF";
        let color = "#";
        for (let i = 0; i < 6; i++) {
          color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
      }
    </script>
  </body>
</html>
