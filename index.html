<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compare LX</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>
    <h1>Welcome to Compare LX</h1>
    <p>This is the homepage for the Compare LX project.</p>
    <canvas id="myChart" width="400" height="400"></canvas>
    
    <label for="universitySelect">Select University:</label>
    <select id="universitySelect" onchange="updateChart()">
        <!-- Dynamically populated options will be added here -->
    </select>

    <label for="startYear">Start Year:</label>
    <select id="startYear" onchange="updateChart()">
        <!-- Options will be added here dynamically -->
    </select>

    <label for="endYear">End Year:</label>
    <select id="endYear" onchange="updateChart()">
        <!-- Options will be added here dynamically -->
    </select>

    <label for="plotType">Select Plot Type:</label>
    <select id="plotType" onchange="updateChart()">
        <option value="time">Degrees by Year</option>
        <option value="faculty">Degrees vs Faculty</option>
    </select>

    <script>
        var degreesData = [];
        var facultyData = [];
        var universityNames = [];
        var yearsAvailable = [];
        
        // Load the degrees CSV
        Papa.parse('./BA-LX-degrees-conferred.csv', {
            download: true,
            header: true,
            complete: function(results) {
                // Restructure the data to make it easier to work with
                degreesData = results.data.map(row => {
                    let institution = row.InstitutionName;
                    let yearsData = [];

                    // Loop through each year (e.g., 2023, 2022, etc.)
                    Object.keys(row).forEach(year => {
                        if (year !== 'InstitutionName') {
                            yearsAvailable.push(year);
                            yearsData.push({
                                year: year,
                                degrees: row[year],
                                institution: institution
                            });
                        }
                    });
                    if (!universityNames.includes(institution)) {
                        universityNames.push(institution);
                    }
                    return yearsData;
                }).flat();  // Flatten the array

                populateDropdowns();
                if (facultyData.length > 0) {
                    mergeData();
                }
            }
        });

        // Load the faculty CSV
        Papa.parse('./num-core-faculty.csv', {
            download: true,
            header: true,
            complete: function(results) {
                facultyData = results.data;
                if (degreesData.length > 0) {
                    mergeData();
                }
            }
        });

        // Merge the data from both CSVs
        function mergeData() {
            const mergedData = degreesData.map(degree => {
                const faculty = facultyData.find(fac => fac.InstitutionName === degree.institution);
                return {
                    ...degree,
                    Faculty_Count: faculty ? faculty.Faculty_Count : null
                };
            });
            
            processMergedData(mergedData);
        }

        // Populate the dropdowns with options
        function populateDropdowns() {
            // Populate university dropdown
            const universitySelect = document.getElementById('universitySelect');
            universityNames.forEach(name => {
                let option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                universitySelect.appendChild(option);
            });

            // Populate year dropdowns
            const startYearSelect = document.getElementById('startYear');
            const endYearSelect = document.getElementById('endYear');
            yearsAvailable = [...new Set(yearsAvailable)].sort();  // Remove duplicates and sort

            yearsAvailable.forEach(year => {
                let optionStart = document.createElement('option');
                optionStart.value = year;
                optionStart.textContent = year;
                startYearSelect.appendChild(optionStart);

                let optionEnd = document.createElement('option');
                optionEnd.value = year;
                optionEnd.textContent = year;
                endYearSelect.appendChild(optionEnd);
            });
        }

        function processMergedData(data) {
            console.log(data); // Check the structure of merged data
            createChart();
        }

        function createChart() {
            var ctx = document.getElementById('myChart').getContext('2d');
            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: '',
                        data: [],
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateChart() {
            const selectedUniversity = document.getElementById('universitySelect').value;
            const plotType = document.getElementById('plotType').value;
            const startYear = document.getElementById('startYear').value;
            const endYear = document.getElementById('endYear').value;

            // Filter data for the selected university and year range
            const filteredData = degreesData.filter(item => 
                item.institution === selectedUniversity &&
                item.year >= startYear && item.year <= endYear
            );

            if (plotType === 'time') {
                // Plot Degrees vs Year
                const years = filteredData.map(item => item.year);
                const degrees = filteredData.map(item => item.degrees);

                window.myChart.data.labels = years;
                window.myChart.data.datasets[0].data = degrees;
                window.myChart.data.datasets[0].label = 'Degrees Conferred';
                window.myChart.update();

            } else if (plotType === 'faculty') {
                // Plot Degrees vs Faculty
                const facultyCount = facultyData.find(item => item.InstitutionName === selectedUniversity).Faculty_Count;
                const degrees = filteredData.map(item => item.degrees);

                window.myChart.data.labels = [facultyCount];
                window.myChart.data.datasets[0].data = degrees;
                window.myChart.data.datasets[0].label = 'Degrees vs Faculty';
                window.myChart.update();
            }
        }
    </script>
</body>
</html>
